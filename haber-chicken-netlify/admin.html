<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Haber Chicken</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .bg-haber-red { background-color: #d9232d; }
        .text-haber-red { color: #d9232d; }
        .border-haber-red { border-color: #d9232d; }
        .bg-haber-yellow { background-color: #fbbd08; }
        .text-haber-yellow { color: #fbbd08; }
        .border-haber-yellow { border-color: #fbbd08; }

        .admin-scroll-panel::-webkit-scrollbar {
            width: 8px;
        }
        .admin-scroll-panel::-webkit-scrollbar-track {
            background: #e5e7eb;
        }
        .admin-scroll-panel::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        .admin-scroll-panel::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="flex flex-col h-screen">
        <header class="flex-shrink-0 flex justify-between items-center p-4 bg-white border-b-2 border-gray-200 shadow-md">
            <h3 class="text-2xl font-bold text-haber-red flex items-center"><i class="fas fa-tools mr-3"></i>Admin Dashboard</h3>
            <a href="./index.html" class="px-4 py-2 bg-haber-red text-white rounded-lg hover:bg-red-700 font-semibold flex items-center space-x-2">
                <i class="fas fa-eye"></i>
                <span>View Menu</span>
            </a>
        </header>
        
        <main class="flex-grow p-4 md:p-6 flex flex-col lg:flex-row gap-6 min-h-0">
            
            <!-- Left Column: SCROLLABLE LISTS -->
            <div class="w-full lg:w-2/3 bg-white p-5 rounded-xl shadow-md overflow-y-auto admin-scroll-panel">
                
                <section class="mb-6 pb-4 border-b">
                    <h4 class="text-xl font-bold mb-3 text-gray-700 flex items-center"><i class="fas fa-folder-open mr-3 text-haber-yellow"></i>Manage Categories</h4>
                    <p class="text-xs text-gray-500 mb-3">To add a category, create an item with a new category name. To delete a category and all its items, click the trash icon.</p>
                    <div id="admin-categories-list" class="space-y-2"></div>
                </section>

                <section class="mb-6 pb-4 border-b">
                     <h4 class="text-xl font-bold mb-3 text-gray-700 flex items-center"><i class="fas fa-star mr-3 text-haber-yellow"></i>Manage Special Offers</h4>
                     <div id="admin-special-offers" class="space-y-2"></div>
                </section>

                <section>
                    <h4 class="text-xl font-bold mb-3 text-gray-700 flex items-center"><i class="fas fa-utensils mr-3 text-haber-yellow"></i>Manage Menu Items</h4>
                    <div id="admin-menu-items" class="space-y-2"></div>
                </section>

            </div>

            <!-- Right Column: FORMS -->
            <div class="w-full lg:w-1/3 bg-white p-5 rounded-xl shadow-md overflow-y-auto admin-scroll-panel">
                <div class="flex flex-col space-y-8">
                    <section>
                        <h4 class="font-bold mb-3 text-gray-600 text-lg">Add / Edit Item</h4>
                        <form id="item-form" class="space-y-3">
                            <input type="hidden" id="item-id">
                            <input type="text" id="item-name" placeholder="Item Name" class="w-full p-2 border rounded-md bg-gray-50" required>
                            <div class="grid grid-cols-2 gap-3">
                                <input type="number" id="item-price" placeholder="Price (L.L.)" step="1000" class="w-full p-2 border rounded-md bg-gray-50" required>
                                <input type="text" id="item-category" placeholder="Category" class="w-full p-2 border rounded-md bg-gray-50" required>
                            </div>
                            <textarea id="item-description" placeholder="Description (optional)" rows="3" class="w-full p-2 border rounded-md bg-gray-50"></textarea>
                            <div class="flex justify-end space-x-2">
                                <button type="button" id="clear-form-button" class="px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300 font-semibold">Clear</button>
                                <button type="submit" class="px-4 py-2 bg-haber-red text-white rounded-lg hover:bg-red-700 font-semibold flex items-center space-x-2"><i class="fas fa-save"></i><span>Save Item</span></button>
                            </div>
                        </form>
                    </section>

                    <section class="border-t pt-8">
                        <h4 class="font-bold mb-3 text-gray-600 text-lg">Create New Offer</h4>
                        <form id="offer-form" class="space-y-3">
                            <select id="offer-item-select" class="w-full p-2 border rounded-md bg-gray-50" required></select>
                            <input type="number" id="offer-price" placeholder="Special Price (L.L.)" step="1000" class="w-full p-2 border rounded-md bg-gray-50" required>
                            <div class="flex justify-end">
                                <button type="submit" class="w-full px-4 py-2 bg-haber-yellow text-gray-800 font-semibold rounded-lg hover:bg-amber-400 transition-colors flex items-center justify-center space-x-2"><i class="fas fa-plus-circle"></i><span>Add to Offers</span></button>
                            </div>
                        </form>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        document.addEventListener('DOMContentLoaded', async () => {

            // Simple auth check
            if (sessionStorage.getItem('isAdminLoggedIn') !== 'true') {
                window.location.href = './index.html';
                return;
            }

            const adminCategoriesList = document.getElementById('admin-categories-list');
            const adminMenuItemsContainer = document.getElementById('admin-menu-items');
            const itemForm = document.getElementById('item-form');
            const itemIdInput = document.getElementById('item-id');
            const itemNameInput = document.getElementById('item-name');
            const itemPriceInput = document.getElementById('item-price');
            const itemCategoryInput = document.getElementById('item-category');
            const itemDescriptionInput = document.getElementById('item-description');
            const clearFormButton = document.getElementById('clear-form-button');
            
            const adminSpecialOffersContainer = document.getElementById('admin-special-offers');
            const offerForm = document.getElementById('offer-form');
            const offerItemSelect = document.getElementById('offer-item-select');
            const offerPriceInput = document.getElementById('offer-price');

            const defaultMenuData = [
                { id: 1, name: 'Whole Grilled Chicken', price: 750000, category: 'Chicken Platters', description: 'Served with fries, garlic paste, and pickles.' },
                { id: 2, name: 'Half Grilled Chicken', price: 400000, category: 'Chicken Platters', description: 'Served with fries, garlic paste, and pickles.' },
                { id: 3, name: 'Chicken Shawarma Platter', price: 500000, category: 'Chicken Platters', description: 'Generous portion of chicken shawarma with sides.' },
                { id: 4, name: 'Chicken Sandwich', price: 250000, category: 'Sandwiches', description: 'Grilled chicken strips in fresh pita bread.' },
                { id: 5, name: 'Tawook Sandwich', price: 300000, category: 'Sandwiches', description: 'Marinated chicken breast cubes, grilled to perfection.' },
                { id: 6, name: 'French Fries', price: 150000, category: 'Sides', description: 'Crispy golden fries.' },
                { id: 7, name: 'Hummus', price: 180000, category: 'Sides', description: 'Creamy chickpea dip.' },
                { id: 8, name: 'Soft Drink', price: 75000, category: 'Beverages', description: 'Coke, Pepsi, 7up.' },
                { id: 9, name: 'Fresh Juice', price: 150000, category: 'Beverages', description: 'Orange or Carrot.' },
                { id: 10, name: 'Family Meal', price: 2500000, category: 'Family Meals', description: '2 whole chickens, large fries, large hummus, garlic, pickles & drinks.' },
                { id: 11, name: 'Double Chicken Burger', price: 450000, category: 'Sandwiches', description: 'Two grilled chicken patties with special sauce.' },
                { id: 12, name: 'Chicken Wings (6 pcs)', price: 350000, category: 'Sides', description: 'Spicy or BBQ chicken wings.' },
                { id: 13, name: 'Coleslaw Salad', price: 120000, category: 'Sides', description: 'Freshly made coleslaw.' },
                { id: 14, name: 'Garlic Bread (4 pcs)', price: 100000, category: 'Sides', description: 'Toasted bread with garlic butter.' },
                { id: 15, name: 'Water', price: 50000, category: 'Beverages', description: 'Small bottle of mineral water.' },
                { id: 16, name: 'Iced Tea', price: 90000, category: 'Beverages', description: 'Lemon or Peach flavor.' },
                { id: 17, name: 'Extra Garlic Sauce', price: 30000, category: 'Extras', description: 'An extra serving of our famous garlic sauce.' },
                { id: 18, name: 'Extra Pickles', price: 30000, category: 'Extras', description: 'An extra serving of mixed pickles.' },
                { id: 19, name: 'Spicy Grilled Chicken', price: 800000, category: 'Chicken Platters', description: 'Whole chicken with a spicy marinade.' },
                { id: 20, name: 'Tawook Platter', price: 600000, category: 'Chicken Platters', description: 'Skewers of marinated chicken breast with sides.' },
            ];

            let menuData = [];
            let specialOffers = [];
            let db, menuDocRef, offersDocRef;

            const formatCurrency = (price) => {
                if (typeof price !== 'number') price = 0;
                return `${price.toLocaleString('en-US')} L.L.`;
            };

            const refreshAllAdmin = () => {
                renderAdminCategories();
                renderAdminMenuItems();
                renderAdminSpecialOffers();
                populateOfferSelect();
            };

            const loadDataFromFirestore = () => {
                onSnapshot(menuDocRef, (doc) => {
                    if (doc.exists()) {
                        menuData = doc.data().items;
                    } else {
                        setDoc(menuDocRef, { items: defaultMenuData });
                        menuData = defaultMenuData;
                    }
                    refreshAllAdmin();
                });

                onSnapshot(offersDocRef, (doc) => {
                    if (doc.exists()) {
                        specialOffers = doc.data().items;
                    } else {
                        setDoc(offersDocRef, { items: [] });
                        specialOffers = [];
                    }
                    refreshAllAdmin();
                });
            };

            const renderAdminCategories = () => {
                const categories = [...new Set(menuData.map(item => item.category))];
                adminCategoriesList.innerHTML = categories.map(cat => `
                    <div class="flex justify-between items-center p-2 rounded-lg bg-gray-50 hover:bg-gray-100">
                        <span class="font-semibold text-gray-700">${cat}</span>
                        <button class="delete-category-btn text-red-500 hover:text-red-700 p-2 rounded-md bg-red-100 hover:bg-red-200" data-category="${cat}" title="Delete Category">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `).join('');
            };

            const renderAdminMenuItems = () => {
                adminMenuItemsContainer.innerHTML = menuData.map(item => `
                    <div class="flex justify-between items-center p-2 border rounded-lg bg-gray-50 hover:bg-gray-100">
                        <div>
                            <p class="font-semibold">${item.name} <span class="text-sm text-gray-500">(${item.category})</span></p>
                            <p class="text-sm text-green-600 font-bold">${formatCurrency(item.price)}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="edit-item-btn text-blue-500 hover:text-blue-700 p-2 rounded-md bg-blue-100 hover:bg-blue-200" data-id="${item.id}" title="Edit"><i class="fas fa-edit"></i></button>
                            <button class="delete-item-btn text-red-500 hover:text-red-700 p-2 rounded-md bg-red-100 hover:bg-red-200" data-id="${item.id}" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `).join('');
            };

            const renderAdminSpecialOffers = () => {
                adminSpecialOffersContainer.innerHTML = specialOffers.length === 0 
                ? '<p class="text-center text-gray-500 p-4">No active offers.</p>'
                : specialOffers.map(offer => {
                    const originalItem = menuData.find(item => item.id === offer.id);
                    if (!originalItem) return '';
                    return `
                    <div class="flex justify-between items-center p-2 border border-haber-yellow rounded-lg bg-yellow-50 hover:bg-yellow-100">
                        <div>
                            <p class="font-semibold">${originalItem.name}</p>
                            <p class="text-sm"><span class="font-bold text-haber-red">${formatCurrency(offer.specialPrice)}</span> <span class="text-gray-500 line-through ml-1">${formatCurrency(originalItem.price)}</span></p>
                        </div>
                        <button class="delete-offer-btn text-red-500 hover:text-red-700 p-2 rounded-md bg-red-100 hover:bg-red-200" data-id="${offer.id}" title="Remove Offer"><i class="fas fa-trash"></i></button>
                    </div>
                `}).join('');
            };
            
            const populateOfferSelect = () => {
                offerItemSelect.innerHTML = '<option value="" disabled selected>Select an item to discount...</option>' + menuData.map(item => `<option value="${item.id}">${item.name}</option>`).join('');
            };

            const clearItemForm = () => {
                itemForm.reset();
                itemIdInput.value = '';
                document.querySelector('#item-form button[type="submit"] span').textContent = 'Save Item';
            };

            const saveMenuItem = async (e) => {
                e.preventDefault();
                const id = itemIdInput.value ? parseInt(itemIdInput.value) : null;
                const name = itemNameInput.value.trim();
                const price = parseFloat(itemPriceInput.value);
                const category = itemCategoryInput.value.trim();
                const description = itemDescriptionInput.value.trim();

                if (!name || isNaN(price) || !category) {
                    alert('Please fill all required fields correctly.');
                    return;
                }

                let updatedMenuData = [...menuData];
                if (id) {
                    const itemIndex = updatedMenuData.findIndex(item => item.id === id);
                    if (itemIndex > -1) {
                        updatedMenuData[itemIndex] = { ...updatedMenuData[itemIndex], name, price, category, description };
                    }
                } else {
                    const newId = updatedMenuData.length > 0 ? Math.max(...updatedMenuData.map(i => i.id)) + 1 : 1;
                    updatedMenuData.push({ id: newId, name, price, category, description });
                }
                
                await setDoc(menuDocRef, { items: updatedMenuData });
                clearItemForm();
            };
            
            const editItem = (id) => {
                const item = menuData.find(i => i.id === id);
                itemIdInput.value = item.id;
                itemNameInput.value = item.name;
                itemPriceInput.value = item.price;
                itemCategoryInput.value = item.category;
                itemDescriptionInput.value = item.description || '';
                document.querySelector('#item-form button[type="submit"] span').textContent = 'Update Item';
                itemNameInput.focus();
            };

            const deleteItem = async (id) => {
                if (confirm('Are you sure you want to delete this item? This will also remove it from any special offers.')) {
                    const updatedMenuData = menuData.filter(i => i.id !== id);
                    const updatedSpecialOffers = specialOffers.filter(o => o.id !== id);
                    await setDoc(menuDocRef, { items: updatedMenuData });
                    await setDoc(offersDocRef, { items: updatedSpecialOffers });
                }
            };
            
            const deleteCategory = async (categoryName) => {
                if (confirm(`Are you sure you want to delete the "${categoryName}" category? ALL items within it will be permanently removed.`)) {
                    const itemIdsToDelete = new Set(menuData.filter(item => item.category === categoryName).map(item => item.id));
                    const updatedMenuData = menuData.filter(item => item.category !== categoryName);
                    const updatedSpecialOffers = specialOffers.filter(offer => !itemIdsToDelete.has(offer.id));
                    await setDoc(menuDocRef, { items: updatedMenuData });
                    await setDoc(offersDocRef, { items: updatedSpecialOffers });
                }
            };

            const addSpecialOffer = async (e) => {
                e.preventDefault();
                const itemId = parseInt(offerItemSelect.value);
                const specialPrice = parseFloat(offerPriceInput.value);

                if (!itemId || isNaN(specialPrice)) {
                    alert('Please select an item and set a valid special price.');
                    return;
                }
                
                if (specialOffers.some(o => o.id === itemId)) {
                    alert('This item is already in special offers. Remove it first to add a new price.');
                    return;
                }

                const updatedSpecialOffers = [...specialOffers, { id: itemId, specialPrice }];
                await setDoc(offersDocRef, { items: updatedSpecialOffers });
                offerForm.reset();
            };
            
            const deleteOffer = async (id) => {
                const updatedSpecialOffers = specialOffers.filter(o => o.id !== id);
                await setDoc(offersDocRef, { items: updatedSpecialOffers });
            };

            try {
                const firebaseConfig = {
                    apiKey: "AIzaSyAVI2Pr17IpIO89O_dQ6HIIZiEY_IicYhE",
                    authDomain: "haberchickenmenu.firebaseapp.com",
                    projectId: "haberchickenmenu",
                    storageBucket: "haberchickenmenu.firebasestorage.app",
                    messagingSenderId: "556537738142",
                    appId: "1:556537738142:web:786c5c0aadedc858aa1c8f",
                    measurementId: "G-4XGDLFV7XN"
                };

                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                db = getFirestore(app);

                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, user => {
                    if (user) {
                        const appId = firebaseConfig.projectId;
                        menuDocRef = doc(db, "artifacts", appId, "public_data", "menu");
                        offersDocRef = doc(db, "artifacts", appId, "public_data", "offers");
                        loadDataFromFirestore();
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                alert("Could not connect to the cloud database. Please check your Firebase setup (Anonymous Sign-in must be enabled).");
            }

            itemForm.addEventListener('submit', saveMenuItem);
            clearFormButton.addEventListener('click', clearItemForm);
            
            adminMenuItemsContainer.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-item-btn');
                const deleteBtn = e.target.closest('.delete-item-btn');
                if (editBtn) {
                    editItem(parseInt(editBtn.dataset.id));
                }
                if (deleteBtn) {
                    deleteItem(parseInt(deleteBtn.dataset.id));
                }
            });

            adminCategoriesList.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-category-btn');
                if (deleteBtn) {
                    const category = deleteBtn.dataset.category;
                    deleteCategory(category);
                }
            });
            
            offerForm.addEventListener('submit', addSpecialOffer);
            adminSpecialOffersContainer.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-offer-btn');
                if(deleteBtn) {
                    deleteOffer(parseInt(deleteBtn.dataset.id));
                }
            });
        });
    </script>
</body>
</html>
